
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wilder (MVP)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0b0f12;
      --card:#0f1720;
      --card2:#101b26;
      --ink:#e7eef7;
      --muted:#9fb2c8;
      --line:rgba(255,255,255,.10);
      --accent:#7ee787;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --shadow: 0 10px 35px rgba(0,0,0,.55);
      --radius:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 40% -10%, rgba(126,231,135,.10), transparent 60%),
                  radial-gradient(900px 700px at 110% 30%, rgba(255,204,102,.08), transparent 55%),
                  var(--bg);
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      gap: 12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(15,23,32,.65);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.1;
    }
    .brand strong{ font-size:16px; letter-spacing:.2px; }
    .brand span{ font-size:12px; color:var(--muted); }
    .pill{
      font-size:12px;
      border:1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      color:var(--muted);
      background: rgba(16,27,38,.55);
      max-width: 52%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .radar{
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
    }

    .mapWrap{
      position:relative;
      flex: 0 0 42%;
      min-height: 240px;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      background: #0a0f14;
    }
    #map{ height:100%; width:100%; }
    .leaflet-tile{
      filter: grayscale(1) contrast(1.25) brightness(.92);
    }

    .reticle{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width: 64px;
      height: 64px;
      pointer-events:none;
      opacity:.95;
    }
    .reticle:before, .reticle:after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 50%;
      border: 2px solid rgba(126,231,135,.8);
      box-shadow: 0 0 0 2px rgba(0,0,0,.35) inset;
    }
    .reticle:after{
      inset: 12px;
      border-color: rgba(126,231,135,.55);
    }
    .reticlePulse{
      position:absolute;
      inset:0;
      border-radius:50%;
      border:2px solid rgba(126,231,135,.35);
      animation: pulse 1.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(.65); opacity:.65; }
      70%{ transform: scale(1.2); opacity:0; }
      100%{ transform: scale(1.2); opacity:0; }
    }
    .mapHUD{
      position:absolute;
      left:12px;
      top:12px;
      right:12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hudBox{
      pointer-events:none;
      border:1px solid var(--line);
      border-radius: 14px;
      padding:8px 10px;
      background: rgba(10,15,20,.65);
      backdrop-filter: blur(8px);
      font-size:12px;
      color:var(--muted);
      max-width: 68%;
    }
    .hudBox b{ color:var(--ink); font-weight:600; }

    .btnRow{
      position:absolute;
      right:12px;
      bottom:12px;
      display:flex;
      gap:8px;
      pointer-events:auto;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(16,27,38,.75);
      color:var(--ink);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }

    .deckWrap{
      flex: 1 1 auto;
      min-height:0;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,23,32,.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .deckHeader{
      padding: 12px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      border-bottom: 1px solid var(--line);
    }
    .deckHeader .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.15;
    }
    .deckHeader .title strong{ font-size:15px; }
    .deckHeader .title span{ color:var(--muted); font-size:12px; }
    .deckHeader .meta{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .deck{
      display:flex;
      gap: 12px;
      padding: 12px 14px 14px;
      overflow-x:auto;
      overflow-y:hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .deck::-webkit-scrollbar{ display:none; }

    .cardMini{
      scroll-snap-align: start;
      flex: 0 0 72%;
      max-width: 360px;
      border:1px solid var(--line);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(16,27,38,.9), rgba(15,23,32,.75));
      box-shadow: 0 12px 30px rgba(0,0,0,.40);
      overflow:hidden;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .miniTop{
      padding:12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .miniName{
      display:flex;
      flex-direction:column;
      gap:4px;
      line-height:1.1;
    }
    .miniName strong{ font-size:16px; }
    .miniName em{ font-style:normal; color:var(--muted); font-size:12px; }
    .badge{
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--ink);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .badge.common{ border-color: rgba(126,231,135,.35); }
    .badge.medium{ border-color: rgba(255,204,102,.35); }
    .badge.rare{ border-color: rgba(255,107,107,.35); }

    .miniVisual{
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      height: 130px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(420px 220px at 20% 20%, rgba(126,231,135,.12), transparent 60%),
        radial-gradient(380px 220px at 80% 70%, rgba(255,204,102,.10), transparent 60%),
        rgba(10,15,20,.35);
    }
    .plantIcon{
      width: 96px;
      height: 96px;
      opacity:.95;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.45));
    }
    .miniBottom{
      padding:10px 12px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .miniBottom b{ color:var(--ink); font-weight:600; }

    .overlay{
      position:fixed;
      inset:0;
      background: rgba(4,7,10,.72);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      z-index:50;
    }
    .overlay.show{ display:flex; }

    .sheet{
      width: min(560px, 100%);
      border-radius: 26px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,27,38,.98), rgba(15,23,32,.94));
      box-shadow: 0 20px 60px rgba(0,0,0,.65);
      overflow:hidden;
      max-height: 92vh;
      display:flex;
      flex-direction:column;
    }
    .sheetTop{
      padding: 12px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
    }
    .sheetNames strong{ display:block; font-size:18px; }
    .sheetNames span{ display:block; color:var(--muted); font-size:13px; margin-top:4px; }
    .sheetClose{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--ink);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .sheetBody{
      padding: 12px 14px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .specVisual{
      border:1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      background:
        radial-gradient(520px 240px at 30% 20%, rgba(126,231,135,.14), transparent 62%),
        radial-gradient(520px 240px at 80% 80%, rgba(255,204,102,.12), transparent 62%),
        rgba(10,15,20,.30);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 12px;
    }
    .specVisual .plantIcon{ width: 160px; height: 160px; }

    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 10px;
      background: rgba(0,0,0,.14);
    }
    .kv label{ display:block; font-size:11px; letter-spacing:.3px; text-transform:uppercase; color:var(--muted); }
    .kv b{ display:block; font-size:15px; margin-top:4px; }

    .block{
      margin-top: 12px;
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px 12px;
      background: rgba(0,0,0,.12);
    }
    .block h3{
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing:.3px;
      text-transform:uppercase;
      color: var(--muted);
      font-weight: 700;
    }
    .block p{
      margin:0;
      font-size: 14px;
      line-height: 1.35;
      color: var(--ink);
    }

    .warning{
      border-color: rgba(255,204,102,.35);
    }
    .warning p{ color: #ffe1a6; }
    .danger{
      border-color: rgba(255,107,107,.35);
    }
    .danger p{ color: #ffb3b3; }

    .actionTab{
      margin-top: 12px;
      width:100%;
      border:1px solid rgba(126,231,135,.35);
      background: linear-gradient(180deg, rgba(126,231,135,.14), rgba(0,0,0,.12));
      color: var(--ink);
      padding: 14px 14px;
      border-radius: 18px;
      font-size: 15px;
      font-weight: 650;
      cursor:pointer;
      text-align:left;
      -webkit-tap-highlight-color: transparent;
    }
    .actionTab:active{ transform: translateY(1px); }

    .flipStage{
      position:relative;
      perspective: 1200px;
      margin-top: 12px;
      display:none;
    }
    .flipStage.show{ display:block; }

    .flip{
      position:relative;
      transform-style: preserve-3d;
      transition: transform .7s ease;
    }
    .flip.flipped{ transform: rotateY(180deg); }

    .face{
      backface-visibility: hidden;
      border:1px solid var(--line);
      border-radius: 22px;
      overflow:hidden;
      background: rgba(10,15,20,.28);
    }
    .face.front{
      padding: 14px;
    }
    .face.back{
      position:absolute;
      inset:0;
      transform: rotateY(180deg);
      background:
        radial-gradient(800px 420px at 30% 20%, rgba(255,255,255,.06), transparent 65%),
        linear-gradient(180deg, rgba(30,22,14,.55), rgba(10,15,20,.25));
      padding: 14px;
    }
    .noteTitle{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      color: rgba(255,255,255,.82);
      letter-spacing:.2px;
      margin:0 0 10px;
    }
    .noteLine{
      border-top:1px dashed rgba(255,255,255,.16);
      margin: 10px 0;
    }
    .note{
      color: rgba(255,255,255,.86);
      font-size: 14px;
      line-height: 1.35;
    }
    .flipBtns{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .smallBtn{
      flex:1;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      padding: 12px;
      border-radius: 16px;
      cursor:pointer;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }

    .modal{
      position:fixed;
      inset:0;
      background: rgba(4,7,10,.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index:80;
    }
    .modal.show{ display:flex; }

    .modalCard{
      width: min(560px, 100%);
      border-radius: 26px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,27,38,.98), rgba(15,23,32,.94));
      box-shadow: 0 24px 70px rgba(0,0,0,.75);
      padding: 16px;
    }
    .modalCard h2{
      margin:0 0 8px;
      font-size: 18px;
    }
    .modalCard p{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }
    .modalCard ul{
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }
    .modalRow{
      display:flex;
      gap:10px;
      margin-top: 14px;
    }
    .modalRow .btn{ flex:1; text-align:center; }
    .btnDanger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.10);
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <strong>Wilder</strong>
        <span>Foraging MVP (Local Edition)</span>
      </div>
      <div class="pill" id="regionPill">Region: Loading…</div>
    </div>

    <div class="radar">
      <div class="mapWrap">
        <div id="map"></div>

        <div class="mapHUD">
          <div class="hudBox" id="hudLeft"><b>Radar</b><br><span id="hudMode">Loading data…</span></div>
          <div class="hudBox" id="hudRight"><b id="hudCount">0</b> cards<br><span id="hudMonth"></span></div>
        </div>

        <div class="reticle">
          <div class="reticlePulse"></div>
        </div>

        <div class="btnRow">
          <div class="btn" id="btnLocate">Locate</div>
          <div class="btn" id="btnAll">All points</div>
          <div class="btn" id="btnResort">Resort</div>
        </div>
      </div>

      <div class="deckWrap">
        <div class="deckHeader">
          <div class="title">
            <strong>The Deck</strong>
            <span>Sorted by nearby observations + seasonality (MVP)</span>
          </div>
          <div class="meta">
            <span class="mono" id="metaDate"></span>
          </div>
        </div>
        <div class="deck" id="deck"></div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetTop">
        <div class="sheetNames">
          <strong id="specSci"></strong>
          <span id="specCommon"></span>
        </div>
        <button class="sheetClose" id="btnClose">Close</button>
      </div>

      <div class="sheetBody">
        <div class="specVisual" id="specVisual"></div>

        <div class="grid" id="specGrid"></div>

        <div class="block" id="specIdBlock">
          <h3>Identification markers</h3>
          <p id="specId"></p>
        </div>

        <div class="block warning" id="specLookBlock" style="display:none;">
          <h3>Lookalike warning</h3>
          <p id="specLook"></p>
        </div>

        <button class="actionTab" id="btnCulinary">View culinary uses →</button>

        <div class="flipStage" id="flipStage">
          <div class="flip" id="flip">
            <div class="face front">
              <div class="block" style="margin-top:0;">
                <h3>Kitchen</h3>
                <p>Tap “Flip card” to see preparation + a simple recipe.</p>
              </div>
              <div class="flipBtns">
                <button class="smallBtn" id="btnFlip">Flip card</button>
                <button class="smallBtn" id="btnHideKitchen">Hide</button>
              </div>
            </div>

            <div class="face back">
              <p class="noteTitle">Recipe card (MVP)</p>
              <div class="note" id="recipeBody"></div>
              <div class="noteLine"></div>
              <div class="flipBtns">
                <button class="smallBtn" id="btnFlipBack">Flip back</button>
                <button class="smallBtn" id="btnHideKitchen2">Close</button>
              </div>
            </div>
          </div>
        </div>

        <div class="block danger" style="margin-top:12px;">
          <h3>Safety</h3>
          <p>Never eat anything you cannot identify with high confidence. This app is a starter pack, not a guarantee.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="riskModal">
    <div class="modalCard">
      <h2>Foraging disclaimer</h2>
      <p>This MVP provides general guidance only. You forage at your own risk.</p>
      <ul>
        <li>Misidentification can cause serious harm.</li>
        <li>Check lookalikes and use multiple ID markers.</li>
        <li>Avoid polluted areas (roadsides, sprayed lawns).</li>
      </ul>
      <div class="modalRow">
        <div class="btn btnDanger" id="btnDecline">I do not agree</div>
        <div class="btn" id="btnAgree">I agree</div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let PLANTS = []; // loaded from data/plants.json
    let REGION = null;

    const state = {
      userLat: 51.3397,  // fallback: Leipzig-ish
      userLon: 12.3731,
      selected: null
    };

    function monthIndex(){
      return new Date().getMonth(); // 0..11
    }
    function monthLabel(){
      return new Date().toLocaleString(undefined, { month:"long", year:"numeric" });
    }
    function scoreLabelFromSeasonality(s){
      if(s === "High") return { label:"Common", cls:"common" };
      if(s === "Medium") return { label:"Occasional", cls:"medium" };
      return { label:"Rare", cls:"rare" };
    }

    function plantIconSVG(seed){
      const hue = (seed.split("").reduce((a,c)=>a+c.charCodeAt(0),0) * 7) % 360;
      return `
        <svg class="plantIcon" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Plant">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0" stop-color="hsla(${hue},70%,55%,.95)"/>
              <stop offset="1" stop-color="hsla(${(hue+35)%360},70%,45%,.95)"/>
            </linearGradient>
          </defs>
          <path d="M100 175 C92 150, 95 125, 100 105 C105 125,108 150,100 175 Z" fill="rgba(255,255,255,.08)"/>
          <path d="M100 105 C70 92, 50 70, 52 52 C70 52, 88 66, 100 88 C112 66,130 52,148 52 C150 70,130 92,100 105 Z"
                fill="url(#g)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
          <path d="M100 88 C90 78, 78 70, 66 64" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="3" stroke-linecap="round"/>
          <path d="M100 88 C110 78, 122 70, 134 64" fill="none" stroke="rgba(0,0,0,.22)" stroke-width="3" stroke-linecap="round"/>
          <circle cx="100" cy="105" r="4" fill="rgba(0,0,0,.25)"/>
        </svg>
      `;
    }

    function toRad(deg){ return deg * Math.PI / 180; }
    function haversineKm(aLat, aLon, bLat, bLon){
      const R = 6371;
      const dLat = toRad(bLat - aLat);
      const dLon = toRad(bLon - aLon);
      const lat1 = toRad(aLat);
      const lat2 = toRad(bLat);
      const s1 = Math.sin(dLat/2);
      const s2 = Math.sin(dLon/2);
      const x = s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2;
      const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
      return R * c;
    }

    function plantNearestDistanceKm(plant, lat, lon){
      let best = Infinity;
      for(const o of (plant.occurrences || [])){
        const olat = o.decimalLatitude;
        const olon = o.decimalLongitude;
        if(typeof olat !== "number" || typeof olon !== "number") continue;
        const d = haversineKm(lat, lon, olat, olon);
        if(d < best) best = d;
      }
      return best;
    }

    function sortedPlants(){
      const m = monthIndex();

      const arr = [...PLANTS].map(p => {
        const season = (p.seasonality && p.seasonality[m]) ? p.seasonality[m] : "Low";
        const seasonRank = (season === "High") ? 3 : (season === "Medium" ? 2 : 1);
        const dist = plantNearestDistanceKm(p, state.userLat, state.userLon);

        return { p, season, seasonRank, dist };
      });

      // Sort by nearest observations first, then seasonality, then frequency, then name.
      arr.sort((a,b) =>
        (a.dist - b.dist) ||
        (b.seasonRank - a.seasonRank) ||
        ((b.p.frequency || 0) - (a.p.frequency || 0)) ||
        (a.p.commonName || "").localeCompare(b.p.commonName || "")
      );

      return arr;
    }

    // Leaflet map
    const map = L.map("map", { zoomControl:false }).setView([state.userLat, state.userLon], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const userMarker = L.circleMarker([state.userLat, state.userLon], {
      radius: 7,
      weight: 2,
      color: "rgba(126,231,135,.85)",
      fillColor: "rgba(126,231,135,.20)",
      fillOpacity: 1
    }).addTo(map);

    const occurrencesLayer = L.layerGroup().addTo(map);

    function setLocation(lat, lon){
      state.userLat = lat;
      state.userLon = lon;
      userMarker.setLatLng([lat, lon]);
      map.setView([lat, lon], 13, { animate:true });
      renderDeck();
    }

    // HUD + Deck elements
    const deckEl = document.getElementById("deck");
    const hudMonthEl = document.getElementById("hudMonth");
    const hudCountEl = document.getElementById("hudCount");
    const metaDateEl = document.getElementById("metaDate");
    const regionPill = document.getElementById("regionPill");
    const hudMode = document.getElementById("hudMode");

    function renderDeck(){
      hudMonthEl.textContent = monthLabel();
      metaDateEl.textContent = monthLabel();

      const items = sortedPlants();
      hudCountEl.textContent = String(items.length);

      deckEl.innerHTML = "";

      for(const {p, season, dist} of items){
        const {label, cls} = scoreLabelFromSeasonality(season);
        const obs = Number.isFinite(p.frequency) ? p.frequency : ((p.occurrences || []).length);

        const card = document.createElement("div");
        card.className = "cardMini";

        const distText = (dist === Infinity) ? "no points" : `${dist.toFixed(1)} km`;

        card.innerHTML = `
          <div class="miniTop">
            <div class="miniName">
              <strong>${escapeHtml(p.commonName || "Unknown")}</strong>
              <em>${escapeHtml(p.scientificName || "")}</em>
            </div>
            <div class="badge ${cls}">${label}</div>
          </div>
          <div class="miniVisual">${plantIconSVG(p.id || p.scientificName || "plant")}</div>
          <div class="miniBottom">
            <span>Obs: <b>${obs}</b> · Nearest: <b>${distText}</b></span>
            <span><b>${escapeHtml(season)}</b></span>
          </div>
        `;

        card.addEventListener("click", () => {
          showPlantOnMap(p);
          openSpecimen(p);
        });

        deckEl.appendChild(card);
      }
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function plotAllOccurrences(){
      occurrencesLayer.clearLayers();

      const pts = [];
      for(const p of PLANTS){
        for(const o of (p.occurrences || [])){
          const lat = o.decimalLatitude;
          const lon = o.decimalLongitude;
          if(typeof lat !== "number" || typeof lon !== "number") continue;

          pts.push([lat, lon]);

          const date = o.eventDate || "unknown date";
          const locality = o.verbatimLocality || "";
          const recordedBy = o.recordedBy ? `Recorded by: ${o.recordedBy}` : "";

          L.circleMarker([lat, lon], {
            radius: 4,
            weight: 1,
            color: "rgba(126,231,135,.75)",
            fillColor: "rgba(126,231,135,.25)",
            fillOpacity: 1
          })
          .bindPopup(
            `<b>${escapeHtml(p.commonName || "")}</b><br>` +
            `${escapeHtml(p.scientificName || "")}<br>` +
            `${escapeHtml(date)}<br>` +
            `${escapeHtml(locality)}<br>` +
            `${escapeHtml(recordedBy)}`
          )
          .addTo(occurrencesLayer);
        }
      }

      // If we have points, fit; otherwise just sit quietly.
      if(pts.length){
        const b = L.latLngBounds(pts);
        map.fitBounds(b, { padding:[20,20] });
      }
    }

    function showPlantOnMap(plant){
      occurrencesLayer.clearLayers();

      const pts = [];
      for(const o of (plant.occurrences || [])){
        const lat = o.decimalLatitude;
        const lon = o.decimalLongitude;
        if(typeof lat !== "number" || typeof lon !== "number") continue;

        pts.push([lat, lon]);

        const date = o.eventDate || "unknown date";
        const locality = o.verbatimLocality || "";
        const recordedBy = o.recordedBy ? `Recorded by: ${o.recordedBy}` : "";

        L.circleMarker([lat, lon], {
          radius: 5,
          weight: 1,
          color: "rgba(255,204,102,.85)",
          fillColor: "rgba(255,204,102,.25)",
          fillOpacity: 1
        })
        .bindPopup(
          `<b>${escapeHtml(plant.commonName || "")}</b><br>` +
          `${escapeHtml(plant.scientificName || "")}<br>` +
          `${escapeHtml(date)}<br>` +
          `${escapeHtml(locality)}<br>` +
          `${escapeHtml(recordedBy)}`
        )
        .addTo(occurrencesLayer);
      }

      if(pts.length){
        map.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
      }
    }

    // Specimen overlay
    const overlay = document.getElementById("overlay");
    const specSci = document.getElementById("specSci");
    const specCommon = document.getElementById("specCommon");
    const specVisual = document.getElementById("specVisual");
    const specGrid = document.getElementById("specGrid");
    const specId = document.getElementById("specId");
    const specLookBlock = document.getElementById("specLookBlock");
    const specLook = document.getElementById("specLook");

    const btnClose = document.getElementById("btnClose");
    btnClose.addEventListener("click", closeSpecimen);
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) closeSpecimen();
    });

    // Kitchen flip
    const btnCulinary = document.getElementById("btnCulinary");
    const flipStage = document.getElementById("flipStage");
    const flip = document.getElementById("flip");
    const recipeBody = document.getElementById("recipeBody");
    const btnFlip = document.getElementById("btnFlip");
    const btnFlipBack = document.getElementById("btnFlipBack");
    const btnHideKitchen = document.getElementById("btnHideKitchen");
    const btnHideKitchen2 = document.getElementById("btnHideKitchen2");

    btnFlip.addEventListener("click", () => flip.classList.add("flipped"));
    btnFlipBack.addEventListener("click", () => flip.classList.remove("flipped"));
    btnHideKitchen.addEventListener("click", () => { flipStage.classList.remove("show"); flip.classList.remove("flipped"); });
    btnHideKitchen2.addEventListener("click", () => { flipStage.classList.remove("show"); flip.classList.remove("flipped"); });

    function openSpecimen(p){
      state.selected = p;

      specSci.textContent = p.scientificName || "";
      specCommon.textContent = p.commonName || "";
      specVisual.innerHTML = plantIconSVG(p.id || p.scientificName || "plant");

      specGrid.innerHTML = "";

      const stats = p.nutritionTopTrumps || {};
      const fallbackStats = {
        "Observations": String(p.frequency ?? (p.occurrences || []).length),
        "Season": (p.seasonality && p.seasonality[monthIndex()]) ? p.seasonality[monthIndex()] : "Low"
      };
      const merged = Object.keys(stats).length ? stats : fallbackStats;

      for(const [k,v] of Object.entries(merged)){
        const kv = document.createElement("div");
        kv.className = "kv";
        kv.innerHTML = `<label>${escapeHtml(k)}</label><b>${escapeHtml(v)}</b>`;
        specGrid.appendChild(kv);
      }

      specId.textContent = p.idMarkers || "No identification markers provided.";

      const warn = (p.lookalikeWarning || "").trim();
      if(warn){
        specLookBlock.style.display = "block";
        specLook.textContent = warn;
      } else {
        specLookBlock.style.display = "none";
      }

      flipStage.classList.remove("show");
      flip.classList.remove("flipped");

      overlay.classList.add("show");
    }

    function closeSpecimen(){
      overlay.classList.remove("show");
      flipStage.classList.remove("show");
      flip.classList.remove("flipped");
    }

    btnCulinary.addEventListener("click", () => {
      if(!state.selected) return;
      const r = state.selected.recipe || { prep:"", simple:"", pairing:"" };

      recipeBody.innerHTML = `
        <div class="note"><b>Preparation:</b> ${escapeHtml(r.prep || "—")}</div>
        <div class="noteLine"></div>
        <div class="note"><b>Simple recipe:</b> ${escapeHtml(r.simple || "—")}</div>
        <div class="noteLine"></div>
        <div class="note"><b>Pairing:</b> ${escapeHtml(r.pairing || "—")}</div>
      `;

      flipStage.classList.add("show");
      flip.classList.remove("flipped");
      setTimeout(() => flipStage.scrollIntoView({ behavior:"smooth", block:"start" }), 50);
    });

    // Buttons
    document.getElementById("btnResort").addEventListener("click", renderDeck);
    document.getElementById("btnAll").addEventListener("click", plotAllOccurrences);
    document.getElementById("btnLocate").addEventListener("click", locate);

    function locate(){
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        (pos) => setLocation(pos.coords.latitude, pos.coords.longitude),
        () => {},
        { enableHighAccuracy:true, timeout: 8000, maximumAge: 60000 }
      );
    }

    // Risk modal (first run)
    const riskModal = document.getElementById("riskModal");
    const btnAgree = document.getElementById("btnAgree");
    const btnDecline = document.getElementById("btnDecline");

    function showRisk(){ riskModal.classList.add("show"); }
    function hideRisk(){ riskModal.classList.remove("show"); }

    btnAgree.addEventListener("click", () => {
      localStorage.setItem("wilder_risk_ok", "true");
      hideRisk();
    });
    btnDecline.addEventListener("click", () => {
      alert("Understood. The app will not continue without agreement.");
    });

    async function loadPlants(){
      hudMode.textContent = "Loading data…";

      const res = await fetch("data/plants.json", { cache: "no-store" });
      if(!res.ok) throw new Error("Failed to load data/plants.json");

      const data = await res.json();
      REGION = data.region || null;

      PLANTS = (data.plants || []).map(p => ({
        ...p,
        frequency: (p.occurrences || []).length
      }));

      const regionName = REGION?.name || "Local Starter Pack";
      regionPill.textContent = `Region: ${regionName}`;

      hudMode.textContent = "Mock GBIF-like occurrences (MVP)";

      // Center map on region center if provided
      if(REGION?.center && typeof REGION.center.lat === "number" && typeof REGION.center.lon === "number"){
        setLocation(REGION.center.lat, REGION.center.lon);
      } else {
        // Still update deck using fallback location
        renderDeck();
      }

      plotAllOccurrences();
    }

    // Init
    locate();

    loadPlants().catch(err => {
      console.error(err);
      hudMode.textContent = "Missing data file: data/plants.json";
      regionPill.textContent = "Region: Error";
    });

    if(localStorage.getItem("wilder_risk_ok") !== "true"){
      showRisk();
    }
  </script>
</body>
</html>
